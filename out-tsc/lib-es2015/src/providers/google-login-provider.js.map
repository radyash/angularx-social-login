{"version":3,"file":"google-login-provider.js","sourceRoot":"","sources":["../../../lib/src/providers/google-login-provider.ts"],"names":[],"mappings":"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","sourcesContent":["import { BaseLoginProvider } from '../entities/base-login-provider';\nimport { SocialUser } from '../entities/user';\nimport { LoginOpt } from '../auth.service';\n\ndeclare let gapi: any;\n\nexport class GoogleLoginProvider extends BaseLoginProvider {\n\n    public static readonly PROVIDER_ID: string = 'GOOGLE';\n\n    protected auth2: any;\n\n    constructor(private clientId: string, private opt: LoginOpt = { scope: 'email' }) { super(); }\n\n    initialize(): Promise<void> {\n        return new Promise((resolve, reject) => {\n            this.loadScript(GoogleLoginProvider.PROVIDER_ID,\n                'https://apis.google.com/js/platform.js',\n                () => {\n                    gapi.load('auth2', () => {\n                        this.auth2 = gapi.auth2.init({\n                            ...this.opt,\n                            client_id: this.clientId\n                        });\n\n                        this.auth2.then(() => {\n                            this._readyState.next(true);\n                            resolve();\n                        }).catch((err: any) => {\n                            reject(err);\n                        });\n                    });\n                });\n        });\n    }\n\n    getLoginStatus(): Promise<SocialUser> {\n        return new Promise((resolve, reject) => {\n            this.onReady().then(() => {\n                if (this.auth2.isSignedIn.get()) {\n                    let user: SocialUser = new SocialUser();\n                    let profile = this.auth2.currentUser.get().getBasicProfile();\n                    let token = this.auth2.currentUser.get().getAuthResponse(true).access_token;\n                    let backendToken = this.auth2.currentUser.get().getAuthResponse(true).id_token;\n                    let refreshToken = this.auth2.currentUser.get().getAuthResponse(true).refresh_token;\n\n                    user.id = profile.getId();\n                    user.name = profile.getName();\n                    user.email = profile.getEmail();\n                    user.photoUrl = profile.getImageUrl();\n                    user.firstName = profile.getGivenName();\n                    user.lastName = profile.getFamilyName();\n                    user.authToken = token;\n                    user.idToken = backendToken;\n                    user.refreshToken = refreshToken;\n                    resolve(user);\n                } else {\n                    reject('No user is currently logged in.');\n                }\n            });\n        });\n    }\n\n    signIn(opt?: LoginOpt): Promise<SocialUser> {\n        return new Promise((resolve, reject) => {\n            this.onReady().then(() => {\n                const offlineAccess: boolean = (opt && opt.offline_access) || (this.opt && this.opt.offline_access);\n                //let promise = !offlineAccess ? this.auth2.signIn(opt) : this.auth2.grantOfflineAccess(opt);\n                console.log('OPT  ' , opt);\n                let promise = this.auth2.grantOfflineAccess(opt);\n\n                promise.then((response: any) => {\n                    let user: SocialUser = new SocialUser();\n                    let profile = this.auth2.currentUser.get().getBasicProfile();\n                    let token = this.auth2.currentUser.get().getAuthResponse(true).access_token;\n                    let backendToken = this.auth2.currentUser.get().getAuthResponse(true).id_token;\n                    let refreshToken = this.auth2.currentUser.get().getAuthResponse(true).refresh_token;\n\n\n                    user.id = profile.getId();\n                    user.name = profile.getName();\n                    user.email = profile.getEmail();\n                    user.photoUrl = profile.getImageUrl();\n                    user.firstName = profile.getGivenName();\n                    user.lastName = profile.getFamilyName();\n                    user.authToken = token;\n                    user.idToken = backendToken;\n                    user.refreshToken = refreshToken;\n\n                    if (response && response.code) {\n                        user.authorizationCode = response.code;\n                    }\n\n                    resolve(user);\n                }, (closed: any) => {\n                    reject('User cancelled login or did not fully authorize.');\n                }).catch((err: any) => {\n                    reject(err);\n                });\n            });\n        });\n    }\n\n    signOut(revoke?: boolean): Promise<any> {\n        return new Promise((resolve, reject) => {\n            this.onReady().then(() => {\n                let signOutPromise;\n                if (revoke) {\n                    signOutPromise = this.auth2.disconnect();\n                } else {\n                    signOutPromise = this.auth2.signOut();\n                }\n\n                signOutPromise.then((err: any) => {\n                    if (err) {\n                        reject(err);\n                    } else {\n                        resolve();\n                    }\n                }).catch((err: any) => {\n                    reject(err);\n                });\n            });\n        });\n    }\n}\n"]}